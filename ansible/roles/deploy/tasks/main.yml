---
- name: Create application directory
  file:
    path: /opt/mpay-app
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'

- name: Create logs directory
  file:
    path: /var/log/mpay-app
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'

- name: Create docker-compose file
  copy:
    dest: /opt/mpay-app/docker-compose.yml
    content: |
      version: '3.8'
      services:
        mpay-app:
          image: {{ registry }}/{{ image_name }}:latest
          container_name: mpay-app
          restart: unless-stopped
          ports:
            - "80:80"
          environment:
            - NODE_ENV=production
          volumes:
            - /var/log/mpay-app:/var/log/nginx
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:80"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
    owner: deploy
    group: deploy
    mode: '0644'

- name: Create deployment script
  copy:
    dest: /opt/mpay-app/deploy.sh
    content: |
      #!/bin/bash
      set -e
      
      echo "ðŸš€ Deploying Mpay App..."
      
      # Pull latest image
      docker pull {{ registry }}/{{ image_name }}:latest
      
      # Stop and remove existing container
      docker stop mpay-app || true
      docker rm mpay-app || true
      
      # Start new container
      docker-compose up -d
      
      # Clean up old images
      docker image prune -f
      
      echo "âœ… Deployment completed successfully!"
    owner: deploy
    group: deploy
    mode: '0755'

- name: Create systemd service file
  copy:
    dest: /etc/systemd/system/mpay-app.service
    content: |
      [Unit]
      Description=Mpay App Docker Service
      Requires=docker.service
      After=docker.service
      
      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/mpay-app
      ExecStart=/opt/mpay-app/deploy.sh
      ExecStop=/usr/bin/docker stop mpay-app
      User=deploy
      Group=deploy
      
      [Install]
      WantedBy=multi-user.target
    owner: root
    group: root
    mode: '0644'

- name: Reload systemd daemon
  systemd:
    daemon_reload: true

- name: Enable mpay-app service
  systemd:
    name: mpay-app
    enabled: true
    state: started

- name: Set up log rotation
  copy:
    dest: /etc/logrotate.d/mpay-app
    content: |
      /var/log/mpay-app/*.log {
          daily
          missingok
          rotate 52
          compress
          delaycompress
          notifempty
          create 644 deploy deploy
          postrotate
              systemctl reload mpay-app
          endscript
      }
    owner: root
    group: root
    mode: '0644' 